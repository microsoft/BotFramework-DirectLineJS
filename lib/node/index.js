!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.DirectLine=t():e.DirectLine=t()}(global,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(o,s,function(t){return e[t]}.bind(null,s));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.User="user",e.Bot="bot"}(t.RoleTypes||(t.RoleTypes={})),function(e){e.Message="message",e.ContactRelationUpdate="contactRelationUpdate",e.ConversationUpdate="conversationUpdate",e.Typing="typing",e.EndOfConversation="endOfConversation",e.Event="event",e.Invoke="invoke",e.DeleteUserData="deleteUserData",e.MessageUpdate="messageUpdate",e.MessageDelete="messageDelete",e.InstallationUpdate="installationUpdate",e.MessageReaction="messageReaction",e.Suggestion="suggestion",e.Trace="trace",e.Handoff="handoff"}(t.ActivityTypes||(t.ActivityTypes={})),function(e){e.Markdown="markdown",e.Plain="plain",e.Xml="xml"}(t.TextFormatTypes||(t.TextFormatTypes={})),function(e){e.List="list",e.Carousel="carousel"}(t.AttachmentLayoutTypes||(t.AttachmentLayoutTypes={})),function(e){e.Like="like",e.PlusOne="plusOne"}(t.MessageReactionTypes||(t.MessageReactionTypes={})),function(e){e.AcceptingInput="acceptingInput",e.IgnoringInput="ignoringInput",e.ExpectingInput="expectingInput"}(t.InputHints||(t.InputHints={})),function(e){e.OpenUrl="openUrl",e.ImBack="imBack",e.PostBack="postBack",e.PlayAudio="playAudio",e.PlayVideo="playVideo",e.ShowImage="showImage",e.DownloadFile="downloadFile",e.Signin="signin",e.Call="call",e.Payment="payment",e.MessageBack="messageBack"}(t.ActionTypes||(t.ActionTypes={})),function(e){e.Unknown="unknown",e.CompletedSuccessfully="completedSuccessfully",e.UserCancelled="userCancelled",e.BotTimedOut="botTimedOut",e.BotIssuedInvalidMessage="botIssuedInvalidMessage",e.ChannelFailed="channelFailed"}(t.EndOfConversationCodes||(t.EndOfConversationCodes={})),function(e){e.Low="low",e.Normal="normal",e.High="high"}(t.ActivityImportance||(t.ActivityImportance={})),function(e){e.Normal="normal",e.Notification="notification"}(t.DeliveryModes||(t.DeliveryModes={})),function(e){e.Add="add",e.Remove="remove"}(t.ContactRelationUpdateActionTypes||(t.ContactRelationUpdateActionTypes={})),function(e){e.Add="add",e.Remove="remove"}(t.InstallationUpdateActionTypes||(t.InstallationUpdateActionTypes={}))},function(e,t,n){"use strict";n.r(t);var o=n(0);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class i{constructor(){if(s(this,"error",void 0),Object.isFrozen(i))throw new Error("ConnectionStatus cannot be constructed")}}function r(e,t){if(null==e)return{};var n,o,s=function(e,t){if(null==e)return{};var n,o,s={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}s(i,"BotError",new i),s(i,"Connecting",new i),s(i,"Ended",new i),s(i,"ExpiredToken",new i),s(i,"FailedToConnect",new i),s(i,"IndeterminateError",new i),s(i,"Online",new i),s(i,"Uninitialized",new i),Object.freeze(i),n.d(t,"DirectLine",function(){return l}),new Function("\n  if (!('FormData' in global)) {\n    global.FormData = require('form-data');\n  }\n\n  if (!('fetch' in global)) {\n    global.fetch = require('node-fetch');\n  }")();var c=Symbol.iterator;class l{constructor(e){a(this,"referenceGrammarId",void 0),a(this,"domain",void 0),a(this,"status",i.Uninitialized),a(this,"conversationId",void 0),a(this,"isomorphicWS",void 0),a(this,"pendingResolvers",new WeakMap),a(this,"pollingInterval",void 0),a(this,"resolver",void 0),a(this,"secret",void 0),a(this,"socketConnection",void 0),a(this,"streamUrl",void 0),a(this,"token",void 0),a(this,"useWebSocket",void 0),a(this,"watermark",""),a(this,"tokenRefreshTimer",void 0);const t=e.conversationId,n=e.domain,o=void 0===n?"https://directline.botframework.com/v3/directline":n,s=e.isomorphicWS,r=e.pollingInterval,c=void 0===r?1e3:r,l=e.secret,d=e.streamUrl,u=e.token,h=e.watermark,p=e.useWebSocket;Object.assign(this,{conversationId:t,domain:o,isomorphicWS:s,pollingInterval:c,secret:l,streamUrl:d,token:u,watermark:h,useWebSocket:p})}*[c](){for(;this.status!==i.Ended;){let e=this.pendingResolvers.get(this.resolver);e&&(yield e),yield e=new Promise(async t=>{if(this.resolver=t,this.pendingResolvers.set(t,e),this.status===i.Uninitialized)t(this.status=i.Connecting);else{const e=await this.checkConnection();if(e)t(e);else if(!this.useWebSocket){t(await this.poll())}}})}}async postActivity(e){if(await this.checkConnection()===i.FailedToConnect){const e=i.FailedToConnect.error,t=e.status,n=e.statusText;throw new Error(`${t}: ${n}`)}if(e.type===o.ActivityTypes.Message&&(e.attachments||[]).length)return this.postMessageWithAttachments(e);const t=this.conversationId,n=this.domain,s=this.headers;s["Content-type"]="application/json";const r=`${n}/conversations/${t}/activities`,a=await fetch(r,{method:"POST",body:JSON.stringify(e),headers:s});if(!a.ok)throw new Error(`${a.status}: ${a.statusText}`);return(await a.json()).id}async reconnect(e){const t=e.token,n=e.streamUrl;return Object.assign(this,{token:t,streamUrl:n}),this.checkConnection()}end(){this.socketConnection&&this.socketConnection.close(1e3),this.resolver(this.status=i.Ended),this.status=i.Uninitialized}async getSesstionId(){if(await this.checkConnection()===i.FailedToConnect)throw new Error("Error: could not connect to the conversation");const e=this.domain,t=this.headers,n=`${e}/session/getsessionid`,o=await fetch(n,{headers:t,credentials:"include"});if(!o.ok)throw new Error(`${o.status}: ${o.statusText}`);return(await o.json()).sessionId}async poll(){for(;this.status===i.Online;){await new Promise(e=>setTimeout(e,this.pollingInterval));const e=this.conversationId,t=this.domain,n=this.headers,o=`${t}/conversations/${e}/activities?watermark=${this.watermark}`,s=await fetch(o,{headers:n});if(!s.ok)return this.processError(s);const i=await s.json(),r=i.activities,a=i.watermark;if(this.watermark=a,(r||[]).length)return r}return null}openSocketConnection(){return this.socketConnection&&this.socketConnection.close(1e3),this.socketConnection=new this.isomorphicWS(this.streamUrl),this.socketConnection.onmessage=(e=>{this.resolver(JSON.parse(e.data))}),this.socketConnection.onclose=(()=>{this.resolver(this.status=i.Ended)}),this.socketConnection.onerror=this.reconnectToConversation,new Promise(e=>this.socketConnection.onopen=(()=>e(i.Online)))}async checkConnection(){if(this.status===i.Online)return null;const e=await this.startConversation(),t=e.status,n=e.statusText;if(!e.ok)return i.FailedToConnect.error={status:t,statusText:n},this.status=i.FailedToConnect;const o=await e.json(),s=o.conversationId,r=o.eTag,a=o.streamUrl,c=o.referenceGrammarId,l=o.token,d=o.expires_in;return Object.assign(this,{conversationId:s,token:l,streamUrl:a,eTag:r,referenceGrammarId:c}),this.secret||this.refreshTokenHeartbeat(d),a&&this.useWebSocket?this.status=await this.openSocketConnection():this.status=i.Online}async startConversation(){const e=this.conversationId,t=this.domain,n=this.headers,o=this.watermark;let s=`${t}/conversations`;return e&&(s+=`/${e}?watermark=${o}`),fetch(s,{method:e?"GET":"POST",headers:n})}refreshTokenHeartbeat(e){this.tokenRefreshTimer&&clearTimeout(this.tokenRefreshTimer);this.tokenRefreshTimer=setTimeout(async()=>{if(this.status===i.Online)return null;const e=`${this.domain}/tokens/refresh`,t=await fetch(e,{method:"POST",headers:this.headers});if(!t.ok)return this.processError(t);const n=await t.json(),o=n.token,s=n.expires_in;return this.token=o,this.refreshTokenHeartbeat(s)},e-36e5)}async reconnectToConversation(){const e=this.conversationId,t=this.domain,n=this.watermark,o=this.headers,s=`${t}/conversations/${e}?watermark=${n}`,i=await fetch(s,{headers:o});if(!i.ok)return this.processError(i);const r=await i.json(),a=r.token,c=r.streamUrl;return Object.assign(this,{token:a,streamUrl:c}),this.status=await this.openSocketConnection()}processError(e){const t=e.status,n=e.statusText;let o;switch(t){case 403:o=i.ExpiredToken;break;case 404:o=i.Ended;break;case 502:o=i.BotError;break;default:o=i.IndeterminateError}return o&&(o.error={status:t,statusText:n}),this.status=o}async postMessageWithAttachments(e){let t=e.attachments,n=r(e,["attachments"]);const o=new FormData;o.append("activity",JSON.stringify(n)),(await Promise.all(t.map(e=>fetch(e.contentUrl)))).forEach(async(e,n)=>{const s=await e.blob(),i=t[n],r=i.name,a=function(e){const t=e.lastIndexOf("/"),n=-1===t?0:t;return e.substr(n)}(i.contentUrl);o.append(r,s,a)});const s=this.domain,i=this.conversationId,a=this.headers,c=`${s}/conversations/${i}/upload?userId=${n.from.id}`,l=await fetch(c,{method:"POST",headers:a,body:o});return 200!==l.status?null:(await l.json()).id}get headers(){return{Accept:"application/json",Authorization:`Bearer ${this.secret||this.token}`}}}}])});